<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Negocio</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- React, ReactDOM & Babel (para transpilar JSX en el navegador) -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Evita el "flash" de contenido sin estilo antes de que React cargue */
        .loading-placeholder { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #111827; color: white; font-size: 1.2rem; }
    </style>
</head>
<body class="bg-gray-900">
    
    <!-- Contenedor donde se montará la aplicación de React -->
    <div id="root">
        <div class="loading-placeholder">Cargando aplicación...</div>
    </div>

    <!-- Firebase SDKs (usando script type="module") -->
    <script type="module">
        // Configuración de tu proyecto de Firebase (¡YA ACTUALIZADA!)
        const firebaseConfig = {
            apiKey: "AIzaSyDn6u2nWYahTsXUpxfadWJNkpyAHiSTA_s",
            authDomain: "comet-v10.firebaseapp.com",
            projectId: "comet-v10",
            storageBucket: "comet-v10.appspot.com",
            messagingSenderId: "861183141332",
            appId: "1:861183141332:web:1b256ba1e4b785bc29e241"
        };

        // No es necesario cambiar esto, es un ID para la estructura de la base de datos.
        const appId = 'app-gestion-negocio-1';

        // Hacemos que las variables de Firebase y React estén disponibles globalmente para ambos scripts
        window.firebaseConfig = firebaseConfig;
        window.appId = appId;
    </script>

    <!-- Código de la Aplicación React (usando Babel para transpilar) -->
    <script type="text/babel" data-presets="react,es2015,stage-2">
        // --- Importaciones de Firebase (ahora desde el SDK global) ---
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
        const { getAuth, signInAnonymously, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js');
        const { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, runTransaction } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
        
        // --- Inicialización de Firebase (usa la config de la ventana global) ---
        const app = initializeApp(window.firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const aId = window.appId; // Usamos el appId global

        // --- Hooks de React ---
        const { useState, useEffect, useMemo } = React;

        // --- ÍCONOS (Componentes SVG) ---
        const DollarSign = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" y1="1" x2="12" y2="23" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></svg>
        );
        const ShoppingCart = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="9" cy="21" r="1" /><circle cx="20" cy="21" r="1" /><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" /></svg>
        );
        const Package = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16.5 9.4l-9-5.19" /><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><polyline points="3.27 6.96 12 12.01 20.73 6.96" /><line x1="12" y1="22.08" x2="12" y2="12" /></svg>
        );
        const LogOut = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></svg>
        );
        const PlusCircle = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="16" /><line x1="8" y1="12" x2="16" y2="12" /></svg>
        );
        const Edit = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>
        );
        const Trash2 = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></svg>
        );
        const ArrowUp = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
        );
        const ArrowDown = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
        );
        const Scale = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m16 16 3-8 3 8c-2 1-4 1-6 0"></path><path d="m2 16 3-8 3 8c-2 1-4 1-6 0"></path><path d="M7 21h10"></path><path d="M12 3v18"></path><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"></path></svg>
        );

        // --- Componente de Login ---
        const LoginScreen = ({ onLogin }) => {
            const [name, setName] = useState('');
            const [error, setError] = useState('');

            const handleLogin = () => {
                const upperCaseName = name.trim().toUpperCase();
                if (upperCaseName === 'SOL' || upperCaseName === 'BRANDON') {
                    onLogin(upperCaseName);
                    setError('');
                } else {
                    setError('Nombre no autorizado. Intenta con "SOL" o "BRANDON".');
                }
            };

            return (
                <div className="flex items-center justify-center h-screen bg-gray-900 text-white">
                    <div className="w-full max-w-md p-8 space-y-8 bg-gray-800 rounded-2xl shadow-lg">
                        <div className="text-center">
                            <h1 className="text-4xl font-bold text-purple-400">Gestión de Negocio</h1>
                            <p className="mt-2 text-gray-400">Bienvenido. Ingresa tu nombre para continuar.</p>
                        </div>
                        <div className="space-y-4">
                            <input
                                type="text"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                placeholder="Escribe tu nombre"
                                className="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                            {error && <p className="text-red-400 text-sm text-center">{error}</p>}
                        </div>
                        <button
                            onClick={handleLogin}
                            className="w-full py-3 font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-purple-500 transition-colors duration-300"
                        >
                            Iniciar Sesión
                        </button>
                    </div>
                </div>
            );
        };

        // --- Componente Modal de Confirmación ---
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
                    <div className="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
                        <h3 className="text-xl font-bold text-white mb-4">{title}</h3>
                        <p className="text-gray-300 mb-6">{message}</p>
                        <div className="flex justify-end space-x-4">
                            <button onClick={onClose} className="px-4 py-2 rounded-md text-gray-300 bg-gray-700 hover:bg-gray-600 transition">Cancelar</button>
                            <button onClick={onConfirm} className="px-4 py-2 rounded-md text-white bg-red-600 hover:bg-red-700 transition">Confirmar</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Componente de Tarjeta de Resumen ---
        const SummaryCard = ({ title, value, icon, colorClass }) => (
            <div className="bg-gray-800 p-6 rounded-xl flex items-center justify-between">
                <div>
                    <p className="text-sm text-gray-400 font-medium">{title}</p>
                    <p className={`text-3xl font-bold ${colorClass}`}>{value}</p>
                </div>
                <div className={`p-3 rounded-full bg-gray-700`}>
                    {icon}
                </div>
            </div>
        );

        // --- Módulo de Finanzas ---
        const Finances = ({ sales, expenses, user, userId }) => {
            const [expenseDescription, setExpenseDescription] = useState('');
            const [expenseAmount, setExpenseAmount] = useState('');
            const [expenseDate, setExpenseDate] = useState(new Date().toISOString().slice(0, 10));

            const [modalState, setModalState] = useState({ isOpen: false, type: null, id: null });
            
            const [filterMonth, setFilterMonth] = useState(new Date().getMonth() + 1);
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());

            const handleAddExpense = async () => {
                if (expenseDescription && expenseAmount > 0) {
                    const privateExpensesCollection = collection(db, `artifacts/${aId}/users/${userId}/expenses`);
                    await addDoc(privateExpensesCollection, {
                        description: expenseDescription,
                        amount: parseFloat(expenseAmount),
                        date: expenseDate,
                        user: user
                    });
                    setExpenseDescription('');
                    setExpenseAmount('');
                    setExpenseDate(new Date().toISOString().slice(0, 10));
                }
            };

            const openModal = (type, id) => setModalState({ isOpen: true, type, id });
            const closeModal = () => setModalState({ isOpen: false, type: null, id: null });

            const handleDelete = async () => {
                const { type, id } = modalState;
                if (!type || !id) return;

                try {
                    if (type === 'expense') {
                        const expenseDocRef = doc(db, `artifacts/${aId}/users/${userId}/expenses`, id);
                        await deleteDoc(expenseDocRef);
                    } else if (type === 'sale') {
                        const saleToDelete = sales.find(s => s.id === id);
                        if (!saleToDelete) throw new Error("Venta no encontrada");

                        await runTransaction(db, async (transaction) => {
                            const inventoryDocRef = doc(db, `artifacts/${aId}/users/${userId}/inventory`, saleToDelete.itemId);
                            const inventoryDoc = await transaction.get(inventoryDocRef);

                            if (inventoryDoc.exists()) {
                                const newStock = inventoryDoc.data().quantity + saleToDelete.quantity;
                                transaction.update(inventoryDocRef, { quantity: newStock });
                            }
                            
                            const saleDocRef = doc(db, `artifacts/${aId}/users/${userId}/sales`, id);
                            transaction.delete(saleDocRef);
                        });
                    }
                } catch (error) {
                    console.error("Error al eliminar:", error);
                } finally {
                    closeModal();
                }
            };
            
            const filteredData = useMemo(() => {
                const filteredSales = sales.filter(sale => {
                    const saleDate = new Date(sale.date + 'T00:00:00');
                    return saleDate.getMonth() + 1 === parseInt(filterMonth) && saleDate.getFullYear() === parseInt(filterYear);
                });
                const filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date + 'T00:00:00');
                    return expenseDate.getMonth() + 1 === parseInt(filterMonth) && expenseDate.getFullYear() === parseInt(filterYear);
                });
                return { filteredSales, filteredExpenses };
            }, [sales, expenses, filterMonth, filterYear]);

            const totalIncome = useMemo(() => sales.reduce((sum, sale) => sum + sale.total, 0), [sales]);
            const totalExpenses = useMemo(() => expenses.reduce((sum, expense) => sum + expense.amount, 0), [expenses]);
            const balance = totalIncome - totalExpenses;
            
            const monthlyIncome = useMemo(() => filteredData.filteredSales.reduce((sum, sale) => sum + sale.total, 0), [filteredData.filteredSales]);
            const monthlyExpenses = useMemo(() => filteredData.filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0), [filteredData.filteredExpenses]);
            const monthlyBalance = monthlyIncome - monthlyExpenses;

            const years = [...new Set(sales.map(s => new Date(s.date).getFullYear()).concat(expenses.map(e => new Date(e.date).getFullYear())))].sort((a,b) => b-a);
            if (!years.includes(new Date().getFullYear())) years.unshift(new Date().getFullYear());

            return (
                <div className="p-4 md:p-6 space-y-6">
                    <ConfirmationModal 
                        isOpen={modalState.isOpen}
                        onClose={closeModal}
                        onConfirm={handleDelete}
                        title="Confirmar Eliminación"
                        message={`¿Estás seguro de que deseas eliminar este registro? ${modalState.type === 'sale' ? 'El stock del artículo se reajustará.' : ''} Esta acción no se puede deshacer.`}
                    />
                    <h2 className="text-2xl font-bold text-white">Resumen General</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <SummaryCard title="Ingresos Totales" value={`$${totalIncome.toFixed(2)}`} icon={<ArrowUp className="text-green-400"/>} colorClass="text-green-400" />
                        <SummaryCard title="Egresos Totales" value={`$${totalExpenses.toFixed(2)}`} icon={<ArrowDown className="text-red-400"/>} colorClass="text-red-400" />
                        <SummaryCard title="Balance General" value={`$${balance.toFixed(2)}`} icon={<Scale className={balance >= 0 ? 'text-green-400' : 'text-red-400'}/>} colorClass={balance >= 0 ? 'text-green-400' : 'text-red-400'} />
                    </div>
                    <div className="bg-gray-800 p-6 rounded-xl">
                         <h2 className="text-2xl font-bold text-white mb-4">Resumen Mensual</h2>
                         <div className="flex flex-col sm:flex-row gap-4 mb-4">
                            <select value={filterMonth} onChange={e => setFilterMonth(e.target.value)} className="w-full sm:w-1/2 bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                {Array.from({length: 12}, (_, i) => i + 1).map(m => <option key={m} value={m}>{new Date(0, m-1).toLocaleString('es-ES', { month: 'long' })}</option>)}
                            </select>
                            <select value={filterYear} onChange={e => setFilterYear(e.target.value)} className="w-full sm:w-1/2 bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                {years.map(y => <option key={y} value={y}>{y}</option>)}
                            </select>
                         </div>
                         <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div className="p-4 bg-gray-700 rounded-lg">
                                <p className="text-sm text-gray-400">Ingresos del Mes</p>
                                <p className="text-2xl font-bold text-green-400">${monthlyIncome.toFixed(2)}</p>
                            </div>
                            <div className="p-4 bg-gray-700 rounded-lg">
                                <p className="text-sm text-gray-400">Egresos del Mes</p>
                                <p className="text-2xl font-bold text-red-400">${monthlyExpenses.toFixed(2)}</p>
                            </div>
                            <div className="p-4 bg-gray-700 rounded-lg">
                                <p className="text-sm text-gray-400">Balance del Mes</p>
                                <p className={`text-2xl font-bold ${monthlyBalance >= 0 ? 'text-green-400' : 'text-red-400'}`}>${monthlyBalance.toFixed(2)}</p>
                            </div>
                         </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-gray-800 p-6 rounded-xl">
                            <h3 className="text-xl font-bold text-white mb-4">Registrar Gasto</h3>
                            <div className="space-y-4">
                                <input type="date" value={expenseDate} onChange={e => setExpenseDate(e.target.value)} className="w-full p-2 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                                <input type="text" placeholder="Descripción del gasto" value={expenseDescription} onChange={e => setExpenseDescription(e.target.value)} className="w-full p-2 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                                <input type="number" placeholder="Monto" value={expenseAmount} onChange={e => setExpenseAmount(e.target.value)} className="w-full p-2 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                                <button onClick={handleAddExpense} className="w-full py-2 font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition">Agregar Gasto</button>
                            </div>
                        </div>
                        <div className="bg-gray-800 p-6 rounded-xl">
                            <h3 className="text-xl font-bold text-white mb-4">Historial de Gastos</h3>
                            <div className="overflow-y-auto max-h-80 pr-2">
                                <ul className="space-y-3">
                                    {expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(expense => (
                                        <li key={expense.id} className="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                                            <div>
                                                <p className="font-semibold text-white">{expense.description}</p>
                                                <p className="text-sm text-gray-400">{new Date(expense.date + 'T00:00:00').toLocaleDateString()} - ${expense.amount.toFixed(2)}</p>
                                            </div>
                                            <button onClick={() => openModal('expense', expense.id)} className="text-gray-400 hover:text-red-500 transition"><Trash2 size={18}/></button>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div className="bg-gray-800 p-6 rounded-xl">
                        <h3 className="text-xl font-bold text-white mb-4">Historial de Ventas</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead>
                                    <tr className="border-b border-gray-700">
                                        <th className="p-3 text-sm font-semibold text-gray-400">Fecha</th>
                                        <th className="p-3 text-sm font-semibold text-gray-400">Artículo</th>
                                        <th className="p-3 text-sm font-semibold text-gray-400">Cantidad</th>
                                        <th className="p-3 text-sm font-semibold text-gray-400">Precio Unit.</th>
                                        <th className="p-3 text-sm font-semibold text-gray-400">Total</th>
                                        <th className="p-3 text-sm font-semibold text-gray-400">Registrado por</th>
                                        <th className="p-3 text-sm font-semibold text-gray-400 text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sales.sort((a, b) => new Date(b.date) - new Date(a.date)).map(sale => (
                                        <tr key={sale.id} className="border-b border-gray-700 hover:bg-gray-700/50">
                                            <td className="p-3 text-white">{new Date(sale.date + 'T00:00:00').toLocaleDateString()}</td>
                                            <td className="p-3 text-white">{sale.itemName}</td>
                                            <td className="p-3 text-white">{sale.quantity}</td>
                                            <td className="p-3 text-white">${sale.unitPrice.toFixed(2)}</td>
                                            <td className="p-3 text-white font-bold">${sale.total.toFixed(2)}</td>
                                            <td className="p-3 text-white">{sale.user}</td>
                                            <td className="p-3 text-right">
                                                <button onClick={() => openModal('sale', sale.id)} className="text-gray-400 hover:text-red-500 transition"><Trash2 size={18}/></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Módulo de Punto de Venta (PDV) ---
        const POS = ({ inventory, user, userId }) => {
            const [date, setDate] = useState(new Date().toISOString().slice(0, 10));
            const [selectedItem, setSelectedItem] = useState('');
            const [quantity, setQuantity] = useState(1);
            const [unitPrice, setUnitPrice] = useState('');
            const [total, setTotal] = useState(0);
            const [error, setError] = useState('');
            
            const availableInventory = inventory.filter(item => item.quantity > 0);

            useEffect(() => {
                if (quantity && unitPrice) {
                    setTotal(parseFloat(quantity) * parseFloat(unitPrice));
                } else {
                    setTotal(0);
                }
            }, [quantity, unitPrice]);

            const handleSale = async () => {
                setError('');
                if (!selectedItem || !quantity || !unitPrice) {
                    setError("Por favor, completa todos los campos.");
                    return;
                }

                const item = inventory.find(i => i.id === selectedItem);
                if (!item) {
                    setError("Artículo no válido.");
                    return;
                }

                const saleQuantity = parseInt(quantity);
                if (saleQuantity <= 0) {
                    setError("La cantidad debe ser mayor a cero.");
                    return;
                }
                if (saleQuantity > item.quantity) {
                    setError(`No hay suficiente stock. Disponible: ${item.quantity}.`);
                    return;
                }
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const inventoryDocRef = doc(db, `artifacts/${aId}/users/${userId}/inventory`, item.id);
                        const inventoryDoc = await transaction.get(inventoryDocRef);
                        if (!inventoryDoc.exists()) throw "El artículo no existe.";
                        
                        const newStock = inventoryDoc.data().quantity - saleQuantity;
                        if (newStock < 0) throw `Stock insuficiente para ${item.name}.`;

                        transaction.update(inventoryDocRef, { quantity: newStock });

                        const salesCollection = collection(db, `artifacts/${aId}/users/${userId}/sales`);
                        const newSaleDoc = doc(salesCollection); // Creamos la referencia primero
                        transaction.set(newSaleDoc, {
                            date: date,
                            itemId: item.id,
                            itemName: item.name,
                            quantity: saleQuantity,
                            unitPrice: parseFloat(unitPrice),
                            total: saleQuantity * parseFloat(unitPrice),
                            user: user
                        });
                    });

                    setDate(new Date().toISOString().slice(0, 10));
                    setSelectedItem('');
                    setQuantity(1);
                    setUnitPrice('');
                    setTotal(0);

                } catch (e) {
                    console.error("Error en la transacción de venta: ", e);
                    setError(`Error al procesar la venta: ${e}`);
                }
            };

            return (
                <div className="p-4 md:p-6 flex justify-center items-start h-full">
                    <div className="w-full max-w-lg bg-gray-800 p-8 rounded-2xl shadow-lg space-y-6">
                        <h2 className="text-3xl font-bold text-white text-center">Punto de Venta</h2>
                        {error && <p className="text-red-400 bg-red-900/50 p-3 rounded-lg text-center">{error}</p>}
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Fecha</label>
                                <input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Artículo Vendido</label>
                                <select value={selectedItem} onChange={e => setSelectedItem(e.target.value)} className="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="">Selecciona un artículo...</option>
                                    {availableInventory.map(item => (
                                        <option key={item.id} value={item.id}>
                                            {item.name} (Disp: {item.quantity})
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-300 mb-1">Cantidad</label>
                                    <input type="number" min="1" value={quantity} onChange={e => setQuantity(e.target.value)} className="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-300 mb-1">Precio Unitario</label>
                                    <input type="number" step="0.01" value={unitPrice} onChange={e => setUnitPrice(e.target.value)} className="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Total de la Venta</label>
                                <input type="text" value={`$${total.toFixed(2)}`} readOnly className="w-full p-3 bg-gray-900 rounded-lg border border-gray-600 text-green-400 font-bold text-lg"/>
                            </div>
                        </div>
                        <button onClick={handleSale} className="w-full py-3 font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors duration-300 flex items-center justify-center gap-2">
                            <ShoppingCart size={20}/>
                            Registrar Venta
                        </button>
                    </div>
                </div>
            );
        };

        // --- Módulo de Inventario ---
        const Inventory = ({ inventory, user, userId }) => {
            const [itemName, setItemName] = useState('');
            const [itemQuantity, setItemQuantity] = useState('');
            const [itemNotes, setItemNotes] = useState('');
            const [editingItem, setEditingItem] = useState(null);
            const [modalState, setModalState] = useState({ isOpen: false, id: null });

            const handleAddItem = async () => {
                if (itemName && itemQuantity) {
                    const privateInventoryCollection = collection(db, `artifacts/${aId}/users/${userId}/inventory`);
                    await addDoc(privateInventoryCollection, {
                        name: itemName,
                        quantity: parseInt(itemQuantity),
                        notes: itemNotes,
                        user: user
                    });
                    resetForm();
                }
            };

            const handleUpdateItem = async () => {
                if (editingItem && itemName && itemQuantity) {
                    const itemDocRef = doc(db, `artifacts/${aId}/users/${userId}/inventory`, editingItem.id);
                    await updateDoc(itemDocRef, {
                        name: itemName,
                        quantity: parseInt(itemQuantity),
                        notes: itemNotes
                    });
                    resetForm();
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (editingItem) {
                    handleUpdateItem();
                } else {
                    handleAddItem();
                }
            };

            const startEditing = (item) => {
                setEditingItem(item);
                setItemName(item.name);
                setItemQuantity(item.quantity);
                setItemNotes(item.notes);
            };

            const resetForm = () => {
                setEditingItem(null);
                setItemName('');
                setItemQuantity('');
                setItemNotes('');
            };

            const openModal = (id) => setModalState({ isOpen: true, id });
            const closeModal = () => setModalState({ isOpen: false, id: null });

            const handleDelete = async () => {
                if (modalState.id) {
                    const itemDocRef = doc(db, `artifacts/${aId}/users/${userId}/inventory`, modalState.id);
                    await deleteDoc(itemDocRef);
                    closeModal();
                }
            };

            return (
                <div className="p-4 md:p-6 space-y-6">
                     <ConfirmationModal 
                        isOpen={modalState.isOpen}
                        onClose={closeModal}
                        onConfirm={handleDelete}
                        title="Confirmar Eliminación"
                        message="¿Estás seguro de que deseas eliminar este artículo del inventario? Esta acción no se puede deshacer."
                    />
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-1 bg-gray-800 p-6 rounded-2xl self-start">
                            <h2 className="text-2xl font-bold text-white mb-4">{editingItem ? 'Editar Artículo' : 'Agregar Artículo'}</h2>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <input type="text" placeholder="Nombre del artículo" value={itemName} onChange={e => setItemName(e.target.value)} required className="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                                <input type="number" placeholder="Cantidad" value={itemQuantity} onChange={e => setItemQuantity(e.target.value)} required min="0" className="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                                <textarea placeholder="Notas (SKU, proveedor, etc.)" value={itemNotes} onChange={e => setItemNotes(e.target.value)} rows="3" className="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                                <div className="flex gap-2">
                                    <button type="submit" className="w-full py-3 font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition flex items-center justify-center gap-2">
                                        <PlusCircle size={20}/>
                                        {editingItem ? 'Actualizar' : 'Agregar'}
                                    </button>
                                    {editingItem && (
                                        <button type="button" onClick={resetForm} className="w-full py-3 font-semibold text-white bg-gray-600 rounded-lg hover:bg-gray-500 transition">
                                            Cancelar
                                        </button>
                                    )}
                                </div>
                            </form>
                        </div>
                        <div className="lg:col-span-2 bg-gray-800 p-6 rounded-2xl">
                            <h2 className="text-2xl font-bold text-white mb-4">Stock Actual</h2>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead>
                                        <tr className="border-b border-gray-700">
                                            <th className="p-3 text-sm font-semibold text-gray-400">Artículo</th>
                                            <th className="p-3 text-sm font-semibold text-gray-400 text-center">Cantidad</th>
                                            <th className="p-3 text-sm font-semibold text-gray-400">Notas</th>
                                            <th className="p-3 text-sm font-semibold text-gray-400 text-right">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {inventory.map(item => (
                                            <tr key={item.id} className="border-b border-gray-700 hover:bg-gray-700/50">
                                                <td className="p-3 font-medium text-white">{item.name}</td>
                                                <td className="p-3 text-center">
                                                    <span className={`px-3 py-1 rounded-full text-sm font-semibold ${item.quantity > 5 ? 'bg-green-800 text-green-200' : item.quantity > 0 ? 'bg-yellow-800 text-yellow-200' : 'bg-red-800 text-red-200'}`}>
                                                        {item.quantity}
                                                    </span>
                                                </td>
                                                <td className="p-3 text-gray-400">{item.notes}</td>
                                                <td className="p-3 text-right space-x-2">
                                                    <button onClick={() => startEditing(item)} className="text-gray-400 hover:text-purple-400 transition p-1"><Edit size={18}/></button>
                                                    <button onClick={() => openModal(item.id)} className="text-gray-400 hover:text-red-500 transition p-1"><Trash2 size={18}/></button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Componente Principal de la App ---
        function App() {
            const [user, setUser] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [page, setPage] = useState('finances');

            const [sales, setSales] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [inventory, setInventory] = useState([]);

            useEffect(() => {
                signInAnonymously(auth).catch(error => console.error("Error de autenticación anónima:", error));

                const unsubscribe = onAuthStateChanged(auth, (firebaseUser) => {
                    if (firebaseUser) {
                        setUserId(firebaseUser.uid);
                    } else {
                        setUserId(null);
                    }
                    setIsAuthReady(true);
                });

                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!isAuthReady || !userId) return;

                const privateSalesCollection = collection(db, `artifacts/${aId}/users/${userId}/sales`);
                const privateExpensesCollection = collection(db, `artifacts/${aId}/users/${userId}/expenses`);
                const privateInventoryCollection = collection(db, `artifacts/${aId}/users/${userId}/inventory`);

                const unsubSales = onSnapshot(privateSalesCollection, (snapshot) => setSales(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                const unsubExpenses = onSnapshot(privateExpensesCollection, (snapshot) => setExpenses(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                const unsubInventory = onSnapshot(privateInventoryCollection, (snapshot) => setInventory(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));

                return () => { unsubSales(); unsubExpenses(); unsubInventory(); };
            }, [isAuthReady, userId]);

            if (!isAuthReady) {
                return <div className="flex items-center justify-center h-screen bg-gray-900 text-white">Conectando con la base de datos...</div>;
            }

            if (!user) {
                return <LoginScreen onLogin={(name) => setUser(name)} />;
            }

            const NavItem = ({ icon, label, name, isMobile }) => {
                const isActive = page === name;
                const baseClasses = "flex items-center gap-3 rounded-lg cursor-pointer transition-colors duration-200";
                const mobileClasses = `flex-col justify-center text-xs ${isActive ? 'text-purple-400' : 'text-gray-400 hover:text-white'}`;
                const desktopClasses = `px-4 py-3 ${isActive ? 'bg-purple-600/20 text-purple-300' : 'text-gray-400 hover:bg-gray-700/50 hover:text-white'}`;

                return (
                    <div onClick={() => setPage(name)} className={isMobile ? mobileClasses : baseClasses + " " + desktopClasses}>
                        {icon}
                        <span>{label}</span>
                    </div>
                );
            };

            return (
                <div className="flex h-screen bg-gray-900 text-white font-sans">
                    <aside className="hidden md:flex flex-col w-64 bg-gray-800 p-4 border-r border-gray-700">
                        <div className="flex items-center gap-3 mb-8">
                            <div className="bg-purple-600 p-2 rounded-lg"><DollarSign className="text-white"/></div>
                            <h1 className="text-xl font-bold">Gestor PRO</h1>
                        </div>
                        <nav className="flex flex-col gap-2 flex-grow">
                            <NavItem icon={<DollarSign size={20}/>} label="Finanzas" name="finances" />
                            <NavItem icon={<ShoppingCart size={20}/>} label="Punto de Venta" name="pos" />
                            <NavItem icon={<Package size={20}/>} label="Inventario" name="inventory" />
                        </nav>
                        <div className="mt-auto">
                             <div className="text-center text-gray-400 text-sm mb-4">
                                <p>Sesión iniciada como:</p>
                                <p className="font-bold text-lg text-white">{user}</p>
                            </div>
                            <div onClick={() => setUser(null)} className="flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer text-gray-400 hover:bg-red-500/20 hover:text-red-400 transition-colors duration-200">
                                <LogOut size={20} />
                                <span>Cerrar Sesión</span>
                            </div>
                        </div>
                    </aside>
                    <main className="flex-1 overflow-y-auto pb-20 md:pb-0">
                        {page === 'finances' && <Finances sales={sales} expenses={expenses} user={user} userId={userId} />}
                        {page === 'pos' && <POS inventory={inventory} user={user} userId={userId} />}
                        {page === 'inventory' && <Inventory inventory={inventory} user={user} userId={userId} />}
                    </main>
                    <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 flex justify-around p-2">
                        <NavItem icon={<DollarSign size={24}/>} label="Finanzas" name="finances" isMobile />
                        <NavItem icon={<ShoppingCart size={24}/>} label="PDV" name="pos" isMobile />
                        <NavItem icon={<Package size={24}/>} label="Inventario" name="inventory" isMobile />
                        <div onClick={() => setUser(null)} className="flex flex-col items-center justify-center text-xs text-gray-400 hover:text-red-400">
                            <LogOut size={24}/>
                            <span>Salir</span>
                        </div>
                    </nav>
                </div>
            );
        }

        // --- Renderizar la aplicación en el DOM ---
        ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
