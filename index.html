<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Financiero y de Stock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/phosphor-icons/1.4.2/css/phosphor.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0D0B14;
            --bg-secondary: #1A1629;
            --bg-tertiary: #1F1C30;
            --border-primary: #2A2540;
            --border-secondary: #3A305A;
            --text-primary: #EAEAEA;
            --text-secondary: #A09CB8;
            --accent-primary: #A755F7;
            --accent-secondary: #C879FF;
            --accent-hover: #8B5CF6;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .main-container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 250px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-secondary);
        }
        .sidebar-header i {
            font-size: 2rem;
            color: var(--accent-secondary);
        }
        .sidebar-header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .nav-button {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            background-color: transparent;
            color: var(--text-secondary);
            border: none;
            width: 100%;
            text-align: left;
            font-size: 1rem;
            font-weight: 500;
            transition: color 0.3s ease, background-color 0.3s ease;
        }
        .nav-button:hover {
            background-color: var(--border-primary);
            color: var(--text-primary);
        }
        .nav-button.active {
            background-color: var(--accent-primary);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.2);
        }
        .nav-button i { font-size: 1.25rem; }
        .content-area {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
        }
        .user-info {
            background-color: var(--bg-secondary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-primary);
            font-weight: 500;
        }
        .user-info span { color: var(--accent-secondary); }

        .card {
            background-color: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid var(--border-primary);
        }
        .card h3 {
            color: var(--accent-secondary);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-secondary);
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 1.25rem;
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            box-sizing: border-box;
            font-size: 0.95rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(167, 85, 247, 0.3);
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(0.8);
        }
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            line-height: 1.5;
        }
        .btn-primary {
            background-color: var(--accent-hover);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.25);
        }
        .btn-primary:hover {
            background-color: #7C3AED;
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.35);
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: var(--border-secondary);
            color: var(--text-secondary);
            border: 1px solid #4A406A;
        }
        .btn-secondary:hover {
            background-color: #4A406A;
            color: var(--accent-secondary);
        }
        .delete-button {
            background-image: linear-gradient(to right, #E53E3E, #C53030);
            color: white;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(200, 50, 50, 0.3);
        }
        .delete-button:hover {
            background-image: linear-gradient(to right, #F56565, #E53E3E);
            box-shadow: 0 4px 12px rgba(200, 50, 50, 0.4);
            transform: translateY(-1px);
        }
        .list-item {
            background-color: var(--bg-tertiary);
            padding: 1.125rem;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--accent-primary);
            transition: background-color 0.3s ease;
        }
        .list-item:hover { background-color: #25213A; }
        .list-item p {
            margin: 0.375rem 0;
            font-size: 0.9rem;
        }
        .list-item strong {
            color: #B0A8D8;
            font-weight: 500;
        }
        .list-item .actions button {
            font-size: 0.8rem;
            padding: 6px 10px;
        }
        .summary-item {
            background-color: var(--border-primary);
            padding: 1.25rem;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border-secondary);
        }
        .summary-item h4 {
            color: var(--accent-secondary);
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .summary-item p {
            color: #FFFFFF;
            font-size: 1.8rem;
            font-weight: 700;
        }
        #loginScreen {
            position: fixed;
            inset: 0;
            background-color: rgba(13, 11, 20, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .login-box {
            background-color: var(--bg-secondary);
            padding: 2.5rem;
            border-radius: 16px;
            border: 1px solid var(--border-primary);
            text-align: center;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .login-box h2 {
            color: white;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .login-box p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }
        #loginNameInput {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }
        #loginError {
            color: #f87171;
            margin-top: -1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            height: 1.25rem; /* Reserve space to prevent layout shift */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-primary);
                flex-direction: row;
                justify-content: space-around;
                padding: 0.5rem;
            }
            .sidebar-header { display: none; }
            .nav-button {
                flex-direction: column;
                gap: 0.25rem;
                padding: 0.75rem 0.5rem;
                font-size: 0.75rem;
            }
            .nav-button i { font-size: 1.5rem; }
            .content-area { padding: 1rem; }
            .page-header h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <h2>Bienvenido/a</h2>
            <p>Por favor, ingrese su nombre para continuar.</p>
            <form id="loginForm">
                <label for="loginNameInput">Nombre (SOL o BRANDON)</label>
                <input type="text" id="loginNameInput" placeholder="Escriba su nombre aquí..." required>
                <div id="loginError"></div>
                <button type="submit" class="btn-primary w-full">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="appContent" class="main-container hidden">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="ph-bold ph-storefront"></i>
                <h1>Mi Negocio</h1>
            </div>
            <nav class="flex-grow flex md:flex-col gap-2">
                <button class="nav-button active" data-page="pdv">
                    <i class="ph-bold ph-shopping-cart-simple"></i>
                    <span>Punto de Venta</span>
                </button>
                <button class="nav-button" data-page="finanzas">
                    <i class="ph-bold ph-chart-bar"></i>
                    <span>Finanzas</span>
                </button>
                <button class="nav-button" data-page="inventario">
                    <i class="ph-bold ph-package"></i>
                    <span>Inventario</span>
                </button>
            </nav>
        </aside>

        <main class="content-area">
            <!-- Punto de Venta Page -->
            <div id="page-pdv" class="page-content active">
                <div class="page-header">
                    <h2>Punto de Venta</h2>
                    <div id="userInfoPdv" class="user-info"></div>
                </div>
                <div class="card">
                    <h3 id="formVentaTitle">Registrar Nueva Venta</h3>
                    <form id="formVenta">
                        <input type="hidden" id="editingVentaId">
                        <div><label for="ventaFecha">Fecha:</label><input type="date" id="ventaFecha" required></div>
                        <div>
                            <label for="ventaProductoSeleccionado">Artículo de Stock Vendido:</label>
                            <select id="ventaProductoSeleccionado" required>
                                <option value="">Seleccione un artículo...</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="ventaCantidad">Cantidad Vendida:</label><input type="number" id="ventaCantidad" min="1" value="1" required></div>
                            <div><label for="ventaPrecioUnitario">Precio Venta Unitario ($):</label><input type="number" id="ventaPrecioUnitario" min="0" step="0.01" placeholder="Ej: 25.00" required></div>
                        </div>
                        <div><label for="ventaTotal">Total Venta ($):</label><input type="text" id="ventaTotal" readonly class="bg-gray-800 text-gray-300"></div>
                        <div><label for="ventaNotas">Notas Adicionales:</label><textarea id="ventaNotas" rows="2" placeholder="Detalles extra de la venta..."></textarea></div>
                        <div class="flex gap-4 mt-6">
                            <button type="submit" id="submitVentaButton" class="btn-primary w-full">Agregar Venta</button>
                            <button type="button" id="cancelEditVentaButton" class="btn-secondary w-full hidden">Cancelar Edición</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Finanzas Page -->
            <div id="page-finanzas" class="page-content">
                <div class="page-header">
                    <h2>Control Financiero</h2>
                    <div id="userInfoFinanzas" class="user-info"></div>
                </div>
                <div class="card mb-8">
                    <h3>Resumen Financiero General</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="summary-item"><h4>Ingresos Totales</h4><p id="totalIngresos">$0.00</p></div>
                        <div class="summary-item"><h4>Egresos Totales</h4><p id="totalEgresos">$0.00</p></div>
                        <div class="summary-item"><h4>Balance General</h4><p id="balanceGeneral">$0.00</p></div>
                    </div>
                </div>
                <div class="card mb-8">
                    <h3>Resumen Mensual</h3>
                    <div class="flex items-end gap-4">
                        <div class="flex-grow"><label for="monthSelector">Seleccionar Mes:</label><input type="month" id="monthSelector"></div>
                        <button id="generateSummaryBtn" class="btn-primary">Generar Resumen</button>
                    </div>
                    <div id="monthlySummaryResult" class="mt-6 hidden"></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card">
                        <h3>Listado de Ventas</h3>
                        <div id="listaVentas" class="max-h-96 overflow-y-auto pr-2"><p class="text-gray-400">Aún no hay ventas registradas.</p></div>
                    </div>
                    <div class="card">
                        <h3>Registrar y Ver Gastos</h3>
                        <form id="formGasto" class="mb-6">
                             <div><label for="gastoFecha">Fecha:</label><input type="date" id="gastoFecha" required></div>
                             <div><label for="gastoDescripcion">Descripción/Servicio:</label><input type="text" id="gastoDescripcion" placeholder="Ej: Suscripción a software" required></div>
                             <div><label for="gastoMonto">Monto Total ($):</label><input type="number" id="gastoMonto" min="0" step="0.01" placeholder="Ej: 49.99" required></div>
                             <button type="submit" class="btn-primary w-full mt-2">Agregar Gasto</button>
                        </form>
                        <div id="listaGastos" class="max-h-96 overflow-y-auto pr-2"><p class="text-gray-400">Aún no hay gastos registrados.</p></div>
                    </div>
                </div>
            </div>

            <!-- Inventario Page -->
            <div id="page-inventario" class="page-content">
                <div class="page-header">
                    <h2>Gestión de Inventario</h2>
                    <div id="userInfoInventario" class="user-info"></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card">
                        <h3 id="formStockTitle">Registrar Artículo</h3>
                        <form id="formStock">
                            <input type="hidden" id="editingStockId">
                            <div><label for="stockNombre">Nombre del Artículo:</label><input type="text" id="stockNombre" placeholder="Ej: Camiseta Negra Talla M" required></div>
                            <div><label for="stockCantidad">Cantidad Actual:</label><input type="number" id="stockCantidad" min="0" placeholder="Ej: 50" required></div>
                            <div><label for="stockNotas">Notas (Opcional):</label><textarea id="stockNotas" rows="3" placeholder="Detalles como SKU, ubicación..."></textarea></div>
                            <div class="flex gap-4 mt-6">
                                <button type="submit" id="submitStockButton" class="btn-primary w-full">Agregar al Stock</button>
                                <button type="button" id="cancelEditStockButton" class="btn-secondary w-full hidden">Cancelar Edición</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <h3>Listado de Stock</h3>
                        <div id="listaStock" class="max-h-[60vh] overflow-y-auto pr-2"><p class="text-gray-400">Aún no hay artículos en stock.</p></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-secondary p-6 rounded-lg shadow-xl max-w-sm w-full border border-border-primary">
            <h3 id="confirmModalTitle" class="text-lg font-semibold text-accent-secondary mb-4">Confirmar Acción</h3>
            <p id="confirmModalMessage" class="text-text-secondary mb-6">¿Está seguro?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirmModalCancel" class="btn-secondary">Cancelar</button>
                <button id="confirmModalConfirm" class="delete-button">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getFirestore, doc, addDoc, collection, onSnapshot, query, deleteDoc, serverTimestamp, setLogLevel, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const firestoreAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        setLogLevel('info');

        // --- Global Variables ---
        let currentUserName = null;
        let originalVentaDataForEdit = null;
        let ventasUnsubscribe = null, gastosUnsubscribe = null, stockUnsubscribe = null;
        let currentVentas = [], currentGastos = [], currentStock = [];

        // --- DOM Elements ---
        const loginScreen = document.getElementById('loginScreen');
        const loginForm = document.getElementById('loginForm');
        const loginNameInput = document.getElementById('loginNameInput');
        const loginError = document.getElementById('loginError');
        const appContent = document.getElementById('appContent');
        
        const navButtons = document.querySelectorAll('.nav-button');
        const pageContents = document.querySelectorAll('.page-content');
        
        const formVenta = document.getElementById('formVenta');
        const formGasto = document.getElementById('formGasto');
        const formStock = document.getElementById('formStock');
        
        const confirmModal = document.getElementById('confirmModal');
        const confirmModalTitle = document.getElementById('confirmModalTitle');
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const confirmModalCancel = document.getElementById('confirmModalCancel');
        const confirmModalConfirm = document.getElementById('confirmModalConfirm');
        let confirmCallback = null;

        // --- Login Logic ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = loginNameInput.value.trim().toUpperCase();
            if (name === 'SOL' || name === 'BRANDON') {
                currentUserName = name.charAt(0) + name.slice(1).toLowerCase();
                loginScreen.classList.add('hidden');
                appContent.classList.remove('hidden');
                initializeAppLogic();
            } else {
                loginError.textContent = 'Nombre no válido. Intente con SOL o BRANDON.';
                loginNameInput.focus();
            }
        });

        // --- App Initialization after Login ---
        function initializeAppLogic() {
            updateUserInfo();
            setDefaultDates();
            setupEventListeners();
            loadAllData();
        }

        function updateUserInfo() {
            const userInfoElements = document.querySelectorAll('.user-info');
            userInfoElements.forEach(el => {
                el.innerHTML = `Usuario: <span>${currentUserName}</span>`;
            });
        }

        // --- Navigation Logic ---
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetPage = button.dataset.page;
                pageContents.forEach(content => {
                    content.classList.toggle('active', content.id === `page-${targetPage}`);
                });
            });
        });

        // --- Confirmation Modal Logic ---
        const showConfirmModal = (title, message, onConfirm) => {
            confirmModalTitle.textContent = title;
            confirmModalMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmModal.classList.remove('hidden');
        };
        confirmModalCancel.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });
        confirmModalConfirm.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });

        // --- Firestore Path Helper ---
        const publicDataPath = (collectionName) => `artifacts/${firestoreAppId}/public/data/${collectionName}`;

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // Sale form
            const ventaCantidadInput = document.getElementById('ventaCantidad');
            const ventaPrecioUnitarioInput = document.getElementById('ventaPrecioUnitario');
            const calcularTotalVenta = () => {
                const cantidad = parseFloat(ventaCantidadInput.value) || 0;
                const precioUnitario = parseFloat(ventaPrecioUnitarioInput.value) || 0;
                document.getElementById('ventaTotal').value = (cantidad * precioUnitario).toFixed(2);
            };
            ventaCantidadInput.addEventListener('input', calcularTotalVenta);
            ventaPrecioUnitarioInput.addEventListener('input', calcularTotalVenta);

            formVenta.addEventListener('submit', handleVentaSubmit);
            document.getElementById('cancelEditVentaButton').addEventListener('click', resetVentaForm);
            
            // Expense form
            formGasto.addEventListener('submit', handleGastoSubmit);

            // Stock form
            formStock.addEventListener('submit', handleStockSubmit);
            document.getElementById('cancelEditStockButton').addEventListener('click', resetStockForm);

            // Monthly summary
            document.getElementById('generateSummaryBtn').addEventListener('click', generateMonthlySummary);

            // Event delegation for edit/delete
            appContent.addEventListener('click', handleActionClick);
        }
        
        // --- Data Loading ---
        function loadAllData() {
            // Unsubscribe from previous listeners if they exist
            if (ventasUnsubscribe) ventasUnsubscribe();
            if (gastosUnsubscribe) gastosUnsubscribe();
            if (stockUnsubscribe) stockUnsubscribe();

            // Load Sales
            const ventasQuery = query(collection(db, publicDataPath('ventas')));
            ventasUnsubscribe = onSnapshot(ventasQuery, snapshot => {
                currentVentas = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                currentVentas.sort((a, b) => (b.timestamp && a.timestamp) ? b.timestamp.toMillis() - a.timestamp.toMillis() : new Date(b.fecha) - new Date(a.fecha));
                displayVentas(currentVentas);
                updateFinancialSummary();
            }, error => console.error("Error loading sales:", error));

            // Load Expenses
            const gastosQuery = query(collection(db, publicDataPath('gastos')));
            gastosUnsubscribe = onSnapshot(gastosQuery, snapshot => {
                currentGastos = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                currentGastos.sort((a, b) => (b.timestamp && a.timestamp) ? b.timestamp.toMillis() - a.timestamp.toMillis() : new Date(b.fecha) - new Date(a.fecha));
                displayGastos(currentGastos);
                updateFinancialSummary();
            }, error => console.error("Error loading expenses:", error));

            // Load Stock
            const stockQuery = query(collection(db, publicDataPath('stock')));
            stockUnsubscribe = onSnapshot(stockQuery, snapshot => {
                currentStock = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                currentStock.sort((a, b) => a.nombre.localeCompare(b.nombre));
                displayStock(currentStock);
                updateProductDropdown();
            }, error => console.error("Error loading stock:", error));
        }

        // --- Form Handlers ---
        async function handleVentaSubmit(e) {
            e.preventDefault();
            const productoSeleccionadoSelect = document.getElementById('ventaProductoSeleccionado');
            const productoSeleccionadoId = productoSeleccionadoSelect.value;
            const productoSeleccionadoNombre = productoSeleccionadoSelect.options[productoSeleccionadoSelect.selectedIndex].text.split(' (Disp:')[0];
            const cantidadVendida = parseInt(formVenta.ventaCantidad.value, 10);
            
            const ventaData = {
                fecha: formVenta.ventaFecha.value,
                stockItemId: productoSeleccionadoId,
                descripcion: productoSeleccionadoNombre,
                cantidad: cantidadVendida,
                precioVentaUnitario: parseFloat(formVenta.ventaPrecioUnitario.value),
                total: parseFloat(document.getElementById('ventaTotal').value),
                notas: formVenta.ventaNotas.value,
                timestamp: serverTimestamp(),
                createdBy: currentUserName
            };

            const editingId = document.getElementById('editingVentaId').value;

            if (editingId) { // UPDATE
                // Complex logic: revert old stock, check availability, deduct new stock
                // This part requires careful implementation to avoid race conditions.
                // For simplicity here, we'll assume the logic from your original code is what's desired.
                // A more robust solution might use Firestore Transactions.
                try {
                    const oldCantidad = originalVentaDataForEdit.cantidad;
                    const oldStockItemId = originalVentaDataForEdit.stockItemId;
                    
                    // Revert old stock quantity
                    await updateDoc(doc(db, publicDataPath('stock'), oldStockItemId), { cantidad: increment(oldCantidad) });
                    
                    // Deduct new quantity from potentially new stock item
                    await updateDoc(doc(db, publicDataPath('stock'), productoSeleccionadoId), { cantidad: increment(-cantidadVendida) });
                    
                    await updateDoc(doc(db, publicDataPath('ventas'), editingId), ventaData);
                    resetVentaForm();
                } catch (error) {
                    console.error("Error updating sale:", error);
                    showConfirmModal("Error", "No se pudo actualizar la venta.", () => {});
                    // Rollback logic would be needed here in a real-world app
                }
            } else { // ADD NEW
                const stockItem = currentStock.find(item => item.id === productoSeleccionadoId);
                if (!stockItem || stockItem.cantidad < cantidadVendida) {
                    showConfirmModal("Error de Stock", `Stock insuficiente para "${productoSeleccionadoNombre}". Disponible: ${stockItem ? stockItem.cantidad : 0}.`, () => {});
                    return;
                }
                try {
                    await addDoc(collection(db, publicDataPath('ventas')), ventaData);
                    await updateDoc(doc(db, publicDataPath('stock'), productoSeleccionadoId), { cantidad: increment(-cantidadVendida) });
                    resetVentaForm();
                } catch (error) {
                    console.error("Error creating sale:", error);
                    showConfirmModal("Error", "No se pudo registrar la venta.", () => {});
                }
            }
        }

        async function handleGastoSubmit(e) {
            e.preventDefault();
            const gastoData = {
                fecha: formGasto.gastoFecha.value,
                descripcion: formGasto.gastoDescripcion.value,
                monto: parseFloat(formGasto.gastoMonto.value),
                timestamp: serverTimestamp(),
                createdBy: currentUserName
            };
            try {
                await addDoc(collection(db, publicDataPath('gastos')), gastoData);
                formGasto.reset();
                setDefaultDates();
            } catch (error) {
                console.error("Error saving expense:", error);
                showConfirmModal("Error", "No se pudo guardar el gasto.", () => {});
            }
        }

        async function handleStockSubmit(e) {
            e.preventDefault();
            const stockData = {
                nombre: formStock.stockNombre.value,
                cantidad: parseInt(formStock.stockCantidad.value, 10),
                notas: formStock.stockNotas.value,
                timestamp: serverTimestamp(),
                createdBy: currentUserName
            };
            const editingId = document.getElementById('editingStockId').value;
            try {
                if (editingId) {
                    await updateDoc(doc(db, publicDataPath('stock'), editingId), stockData);
                } else {
                    await addDoc(collection(db, publicDataPath('stock')), stockData);
                }
                resetStockForm();
            } catch (error) {
                console.error("Error with stock item:", error);
                showConfirmModal("Error", "No se pudo guardar el artículo.", () => {});
            }
        }
        
        // --- Action Click Handler (Delegation) ---
        function handleActionClick(event) {
            const target = event.target;
            const docId = target.dataset.id;
            const tipo = target.dataset.tipo;

            if (!docId || !tipo) return;

            if (target.classList.contains('delete-button')) {
                handleDeleteDocument(tipo, docId);
            } else if (target.classList.contains('edit-button')) {
                if (tipo === 'ventas') handleEditVenta(docId);
                if (tipo === 'stock') handleEditStock(docId);
            }
        }

        // --- Edit & Delete Logic ---
        function handleDeleteDocument(tipo, docId) {
            const itemName = tipo === 'ventas' ? 'venta' : tipo === 'gastos' ? 'gasto' : 'artículo de stock';
            let confirmMessage = `¿Seguro que desea eliminar este ${itemName}?`;
            if (tipo === 'ventas') confirmMessage += " El stock del artículo se reajustará.";
            
            showConfirmModal('Confirmar Eliminación', confirmMessage, async () => {
                try {
                    if (tipo === 'ventas') {
                        const ventaDoc = await getDoc(doc(db, publicDataPath('ventas'), docId));
                        if (ventaDoc.exists()) {
                            const ventaData = ventaDoc.data();
                            if (ventaData.stockItemId && ventaData.cantidad > 0) {
                                await updateDoc(doc(db, publicDataPath('stock'), ventaData.stockItemId), {
                                    cantidad: increment(ventaData.cantidad)
                                });
                            }
                        }
                    }
                    await deleteDoc(doc(db, publicDataPath(tipo), docId));
                    if (tipo === 'ventas' && document.getElementById('editingVentaId').value === docId) resetVentaForm();
                    if (tipo === 'stock' && document.getElementById('editingStockId').value === docId) resetStockForm();
                } catch (error) {
                    console.error(`Error deleting ${itemName}:`, error);
                    showConfirmModal("Error", `No se pudo eliminar el ${itemName}.`, () => {});
                }
            });
        }

        function handleEditVenta(ventaId) {
            const venta = currentVentas.find(v => v.id === ventaId);
            if (!venta) return;
            
            originalVentaDataForEdit = { ...venta };
            
            document.getElementById('editingVentaId').value = ventaId;
            document.getElementById('formVentaTitle').textContent = 'Editar Venta';
            document.getElementById('submitVentaButton').textContent = 'Actualizar Venta';
            document.getElementById('cancelEditVentaButton').classList.remove('hidden');

            formVenta.ventaFecha.value = venta.fecha;
            document.getElementById('ventaProductoSeleccionado').value = venta.stockItemId;
            formVenta.ventaCantidad.value = venta.cantidad;
            formVenta.ventaPrecioUnitario.value = venta.precioVentaUnitario;
            formVenta.ventaNotas.value = venta.notas;
            document.getElementById('ventaTotal').value = venta.total.toFixed(2);
            
            // Switch to PDV page and scroll to form
            document.querySelector('.nav-button[data-page="pdv"]').click();
            formVenta.scrollIntoView({ behavior: 'smooth' });
        }

        function handleEditStock(stockId) {
            const stockItem = currentStock.find(s => s.id === stockId);
            if (!stockItem) return;

            document.getElementById('editingStockId').value = stockId;
            document.getElementById('formStockTitle').textContent = 'Editar Artículo';
            document.getElementById('submitStockButton').textContent = 'Actualizar Artículo';
            document.getElementById('cancelEditStockButton').classList.remove('hidden');

            formStock.stockNombre.value = stockItem.nombre;
            formStock.stockCantidad.value = stockItem.cantidad;
            formStock.stockNotas.value = stockItem.notas;
            formStock.scrollIntoView({ behavior: 'smooth' });
        }

        // --- UI Display & Update Functions ---
        function displayVentas(ventas) {
            const div = document.getElementById('listaVentas');
            div.innerHTML = ventas.length === 0 ? '<p class="text-gray-400">Aún no hay ventas registradas.</p>' : '';
            ventas.forEach(v => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <p><strong>Fecha:</strong> ${v.fecha}</p>
                    <p><strong>Artículo:</strong> ${v.descripcion || 'N/A'}</p>
                    <p><strong>Total:</strong> $${parseFloat(v.total || 0).toFixed(2)}</p>
                    <p class="text-xs text-gray-500 pt-1">Registrado por: ${v.createdBy || 'N/A'}</p>
                    <div class="actions mt-2 flex gap-2">
                        <button data-tipo="ventas" data-id="${v.id}" class="edit-button btn-secondary">Editar</button>
                        <button data-tipo="ventas" data-id="${v.id}" class="delete-button">Eliminar</button>
                    </div>`;
                div.appendChild(item);
            });
        }

        function displayGastos(gastos) {
            const div = document.getElementById('listaGastos');
            div.innerHTML = gastos.length === 0 ? '<p class="text-gray-400">Aún no hay gastos registrados.</p>' : '';
            gastos.forEach(g => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <p><strong>Fecha:</strong> ${g.fecha}</p>
                    <p><strong>Descripción:</strong> ${g.descripcion}</p>
                    <p><strong>Monto:</strong> $${parseFloat(g.monto || 0).toFixed(2)}</p>
                    <p class="text-xs text-gray-500 pt-1">Registrado por: ${g.createdBy || 'N/A'}</p>
                    <div class="actions mt-2 flex gap-2">
                        <button data-tipo="gastos" data-id="${g.id}" class="delete-button">Eliminar</button>
                    </div>`;
                div.appendChild(item);
            });
        }

        function displayStock(stockItems) {
            const div = document.getElementById('listaStock');
            div.innerHTML = stockItems.length === 0 ? '<p class="text-gray-400">Aún no hay artículos en stock.</p>' : '';
            stockItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'list-item';
                itemDiv.innerHTML = `
                    <p><strong>Nombre:</strong> ${item.nombre}</p>
                    <p><strong>Cantidad:</strong> ${item.cantidad}</p>
                    ${item.notas ? `<p><strong>Notas:</strong> ${item.notas}</p>` : ''}
                    <p class="text-xs text-gray-500 pt-1">Registrado por: ${item.createdBy || 'N/A'}</p>
                    <div class="actions mt-2 flex gap-2">
                        <button data-tipo="stock" data-id="${item.id}" class="edit-button btn-secondary">Editar</button>
                        <button data-tipo="stock" data-id="${item.id}" class="delete-button">Eliminar</button>
                    </div>`;
                div.appendChild(itemDiv);
            });
        }

        function updateFinancialSummary() {
            const totalIngresos = currentVentas.reduce((sum, v) => sum + (v.total || 0), 0);
            const totalEgresos = currentGastos.reduce((sum, g) => sum + (g.monto || 0), 0);
            const balanceGeneral = totalIngresos - totalEgresos;

            document.getElementById('totalIngresos').textContent = `$${totalIngresos.toFixed(2)}`;
            document.getElementById('totalEgresos').textContent = `$${totalEgresos.toFixed(2)}`;
            const balanceEl = document.getElementById('balanceGeneral');
            balanceEl.textContent = `$${balanceGeneral.toFixed(2)}`;
            balanceEl.style.color = balanceGeneral >= 0 ? '#4ade80' : '#f87171';
        }

        function updateProductDropdown() {
            const select = document.getElementById('ventaProductoSeleccionado');
            const currentValue = select.value;
            select.innerHTML = '<option value="">Seleccione un artículo...</option>';
            currentStock.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.nombre} (Disp: ${item.cantidad})`;
                option.disabled = item.cantidad === 0;
                select.appendChild(option);
            });
            select.value = currentValue;
        }
        
        // --- Monthly Summary ---
        function generateMonthlySummary() {
            const monthSelector = document.getElementById('monthSelector');
            const resultDiv = document.getElementById('monthlySummaryResult');
            const selectedMonth = monthSelector.value; // YYYY-MM

            if (!selectedMonth) {
                showConfirmModal("Aviso", "Por favor, seleccione un mes y año.", () => {});
                return;
            }

            const [year, month] = selectedMonth.split('-');

            const monthlyVentas = currentVentas.filter(v => v.fecha.startsWith(selectedMonth));
            const monthlyGastos = currentGastos.filter(g => g.fecha.startsWith(selectedMonth));

            const monthlyIngresos = monthlyVentas.reduce((sum, v) => sum + v.total, 0);
            const monthlyEgresos = monthlyGastos.reduce((sum, g) => sum + g.monto, 0);
            const monthlyBalance = monthlyIngresos - monthlyEgresos;

            resultDiv.innerHTML = `
                <div class="grid grid-cols-3 gap-4">
                    <div class="summary-item !bg-tertiary"><h4>Ingresos del Mes</h4><p>$${monthlyIngresos.toFixed(2)}</p></div>
                    <div class="summary-item !bg-tertiary"><h4>Egresos del Mes</h4><p>$${monthlyEgresos.toFixed(2)}</p></div>
                    <div class="summary-item !bg-tertiary"><h4>Balance del Mes</h4><p style="color: ${monthlyBalance >= 0 ? '#4ade80' : '#f87171'}">$${monthlyBalance.toFixed(2)}</p></div>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        }

        // --- Utility & Reset Functions ---
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ventaFecha').value = today;
            document.getElementById('gastoFecha').value = today;
            document.getElementById('monthSelector').value = today.substring(0, 7);
        }

        function resetVentaForm() {
            formVenta.reset();
            document.getElementById('editingVentaId').value = '';
            document.getElementById('formVentaTitle').textContent = 'Registrar Nueva Venta';
            document.getElementById('submitVentaButton').textContent = 'Agregar Venta';
            document.getElementById('cancelEditVentaButton').classList.add('hidden');
            setDefaultDates();
            document.getElementById('ventaTotal').value = '0.00';
            originalVentaDataForEdit = null;
        }

        function resetStockForm() {
            formStock.reset();
            document.getElementById('editingStockId').value = '';
            document.getElementById('formStockTitle').textContent = 'Registrar Artículo';
            document.getElementById('submitStockButton').textContent = 'Agregar al Stock';
            document.getElementById('cancelEditStockButton').classList.add('hidden');
        }

    </script>
</body>
</html>

